#!/usr/bin/env python3
# This file is part of ProGearSDK.
# Copyright (c) 2024-2025 ProGearSDK contributors
# SPDX-License-Identifier: MIT

"""
Generate NeoGeo S-ROM (fix layer) font from simple ASCII art definitions.

S-ROM tile format:
- 8x8 pixels, 4bpp (16 colors)
- 32 bytes per tile
- Column-based storage with interleaved columns
- Byte layout: each byte holds 2 pixels (left in bits 0-3, right in bits 4-7)

Address bits: ...nHCLLL
  n = tile number
  H = half (0=right columns 4-7, 1=left columns 0-3)
  C = column pair (0=outer columns, 1=inner columns)
  L = line (0-7)

So for each tile, the 32 bytes are arranged as:
  Bytes 0-7:   Right half, outer column (cols 4,5), lines 0-7
  Bytes 8-15:  Right half, inner column (cols 6,7), lines 0-7
  Bytes 16-23: Left half, outer column (cols 0,1), lines 0-7
  Bytes 24-31: Left half, inner column (cols 2,3), lines 0-7
"""

import sys

# Simple 8x8 font definition using '#' for foreground, ' ' for background
FONT = {
    ' ': [
        "        ",
        "        ",
        "        ",
        "        ",
        "        ",
        "        ",
        "        ",
        "        ",
    ],
    '!': [
        "   ##   ",
        "   ##   ",
        "   ##   ",
        "   ##   ",
        "   ##   ",
        "        ",
        "   ##   ",
        "        ",
    ],
    '"': [
        " ## ##  ",
        " ## ##  ",
        "        ",
        "        ",
        "        ",
        "        ",
        "        ",
        "        ",
    ],
    '#': [
        " ## ##  ",
        " ## ##  ",
        "########",
        " ## ##  ",
        "########",
        " ## ##  ",
        " ## ##  ",
        "        ",
    ],
    '$': [
        "   ##   ",
        " ###### ",
        "## ##   ",
        " #####  ",
        "   ## ##",
        "###### ",
        "   ##   ",
        "        ",
    ],
    '%': [
        "##   ## ",
        "##  ##  ",
        "   ##   ",
        "  ##    ",
        " ##     ",
        "##   ## ",
        "     ## ",
        "        ",
    ],
    '&': [
        "  ###   ",
        " ## ##  ",
        "  ###   ",
        " ###    ",
        "## ## ##",
        "##  ##  ",
        " ### ## ",
        "        ",
    ],
    "'": [
        "   ##   ",
        "   ##   ",
        "        ",
        "        ",
        "        ",
        "        ",
        "        ",
        "        ",
    ],
    '(': [
        "    ##  ",
        "   ##   ",
        "  ##    ",
        "  ##    ",
        "  ##    ",
        "   ##   ",
        "    ##  ",
        "        ",
    ],
    ')': [
        "  ##    ",
        "   ##   ",
        "    ##  ",
        "    ##  ",
        "    ##  ",
        "   ##   ",
        "  ##    ",
        "        ",
    ],
    '*': [
        "        ",
        " ## ##  ",
        "  ####  ",
        "########",
        "  ####  ",
        " ## ##  ",
        "        ",
        "        ",
    ],
    '+': [
        "        ",
        "   ##   ",
        "   ##   ",
        " ###### ",
        "   ##   ",
        "   ##   ",
        "        ",
        "        ",
    ],
    ',': [
        "        ",
        "        ",
        "        ",
        "        ",
        "        ",
        "   ##   ",
        "   ##   ",
        "  ##    ",
    ],
    '-': [
        "        ",
        "        ",
        "        ",
        " ###### ",
        "        ",
        "        ",
        "        ",
        "        ",
    ],
    '.': [
        "        ",
        "        ",
        "        ",
        "        ",
        "        ",
        "   ##   ",
        "   ##   ",
        "        ",
    ],
    '/': [
        "      ##",
        "     ## ",
        "    ##  ",
        "   ##   ",
        "  ##    ",
        " ##     ",
        "##      ",
        "        ",
    ],
    '0': [
        "  ####  ",
        " ##  ## ",
        "##    ##",
        "##    ##",
        "##    ##",
        " ##  ## ",
        "  ####  ",
        "        ",
    ],
    '1': [
        "   ##   ",
        "  ###   ",
        "   ##   ",
        "   ##   ",
        "   ##   ",
        "   ##   ",
        " ###### ",
        "        ",
    ],
    '2': [
        " #####  ",
        "##   ## ",
        "     ## ",
        "   ###  ",
        "  ##    ",
        " ##     ",
        "####### ",
        "        ",
    ],
    '3': [
        " #####  ",
        "##   ## ",
        "     ## ",
        "  ####  ",
        "     ## ",
        "##   ## ",
        " #####  ",
        "        ",
    ],
    '4': [
        "    ### ",
        "   # ## ",
        "  #  ## ",
        " #   ## ",
        "########",
        "     ## ",
        "     ## ",
        "        ",
    ],
    '5': [
        "####### ",
        "##      ",
        "######  ",
        "     ## ",
        "     ## ",
        "##   ## ",
        " #####  ",
        "        ",
    ],
    '6': [
        "  ####  ",
        " ##     ",
        "##      ",
        "######  ",
        "##   ## ",
        "##   ## ",
        " #####  ",
        "        ",
    ],
    '7': [
        "####### ",
        "     ## ",
        "    ##  ",
        "   ##   ",
        "  ##    ",
        "  ##    ",
        "  ##    ",
        "        ",
    ],
    '8': [
        " #####  ",
        "##   ## ",
        "##   ## ",
        " #####  ",
        "##   ## ",
        "##   ## ",
        " #####  ",
        "        ",
    ],
    '9': [
        " #####  ",
        "##   ## ",
        "##   ## ",
        " ###### ",
        "     ## ",
        "    ##  ",
        " ####   ",
        "        ",
    ],
    ':': [
        "        ",
        "   ##   ",
        "   ##   ",
        "        ",
        "   ##   ",
        "   ##   ",
        "        ",
        "        ",
    ],
    ';': [
        "        ",
        "   ##   ",
        "   ##   ",
        "        ",
        "   ##   ",
        "   ##   ",
        "  ##    ",
        "        ",
    ],
    '<': [
        "    ##  ",
        "   ##   ",
        "  ##    ",
        " ##     ",
        "  ##    ",
        "   ##   ",
        "    ##  ",
        "        ",
    ],
    '=': [
        "        ",
        "        ",
        " ###### ",
        "        ",
        " ###### ",
        "        ",
        "        ",
        "        ",
    ],
    '>': [
        "  ##    ",
        "   ##   ",
        "    ##  ",
        "     ## ",
        "    ##  ",
        "   ##   ",
        "  ##    ",
        "        ",
    ],
    '?': [
        " #####  ",
        "##   ## ",
        "     ## ",
        "   ###  ",
        "   ##   ",
        "        ",
        "   ##   ",
        "        ",
    ],
    '@': [
        " #####  ",
        "##   ## ",
        "## #### ",
        "## # ## ",
        "## #### ",
        "##      ",
        " #####  ",
        "        ",
    ],
    'A': [
        "  ####  ",
        " ##  ## ",
        "##    ##",
        "########",
        "##    ##",
        "##    ##",
        "##    ##",
        "        ",
    ],
    'B': [
        "#####   ",
        "##  ##  ",
        "##  ##  ",
        "#####   ",
        "##  ##  ",
        "##  ##  ",
        "#####   ",
        "        ",
    ],
    'C': [
        " #####  ",
        "##   ## ",
        "##      ",
        "##      ",
        "##      ",
        "##   ## ",
        " #####  ",
        "        ",
    ],
    'D': [
        "#####   ",
        "##  ##  ",
        "##   ## ",
        "##   ## ",
        "##   ## ",
        "##  ##  ",
        "#####   ",
        "        ",
    ],
    'E': [
        "####### ",
        "##      ",
        "##      ",
        "#####   ",
        "##      ",
        "##      ",
        "####### ",
        "        ",
    ],
    'F': [
        "####### ",
        "##      ",
        "##      ",
        "#####   ",
        "##      ",
        "##      ",
        "##      ",
        "        ",
    ],
    'G': [
        " #####  ",
        "##   ## ",
        "##      ",
        "## #### ",
        "##   ## ",
        "##   ## ",
        " #####  ",
        "        ",
    ],
    'H': [
        "##   ## ",
        "##   ## ",
        "##   ## ",
        "####### ",
        "##   ## ",
        "##   ## ",
        "##   ## ",
        "        ",
    ],
    'I': [
        " ###### ",
        "   ##   ",
        "   ##   ",
        "   ##   ",
        "   ##   ",
        "   ##   ",
        " ###### ",
        "        ",
    ],
    'J': [
        "   #### ",
        "    ##  ",
        "    ##  ",
        "    ##  ",
        "    ##  ",
        "##  ##  ",
        " ####   ",
        "        ",
    ],
    'K': [
        "##   ## ",
        "##  ##  ",
        "## ##   ",
        "####    ",
        "## ##   ",
        "##  ##  ",
        "##   ## ",
        "        ",
    ],
    'L': [
        "##      ",
        "##      ",
        "##      ",
        "##      ",
        "##      ",
        "##      ",
        "####### ",
        "        ",
    ],
    'M': [
        "##   ## ",
        "### ### ",
        "## # ## ",
        "##   ## ",
        "##   ## ",
        "##   ## ",
        "##   ## ",
        "        ",
    ],
    'N': [
        "##   ## ",
        "###  ## ",
        "#### ## ",
        "## #### ",
        "##  ### ",
        "##   ## ",
        "##   ## ",
        "        ",
    ],
    'O': [
        " #####  ",
        "##   ## ",
        "##   ## ",
        "##   ## ",
        "##   ## ",
        "##   ## ",
        " #####  ",
        "        ",
    ],
    'P': [
        "######  ",
        "##   ## ",
        "##   ## ",
        "######  ",
        "##      ",
        "##      ",
        "##      ",
        "        ",
    ],
    'Q': [
        " #####  ",
        "##   ## ",
        "##   ## ",
        "##   ## ",
        "## # ## ",
        "##  ##  ",
        " ### ## ",
        "        ",
    ],
    'R': [
        "######  ",
        "##   ## ",
        "##   ## ",
        "######  ",
        "## ##   ",
        "##  ##  ",
        "##   ## ",
        "        ",
    ],
    'S': [
        " #####  ",
        "##   ## ",
        "##      ",
        " #####  ",
        "     ## ",
        "##   ## ",
        " #####  ",
        "        ",
    ],
    'T': [
        "########",
        "   ##   ",
        "   ##   ",
        "   ##   ",
        "   ##   ",
        "   ##   ",
        "   ##   ",
        "        ",
    ],
    'U': [
        "##   ## ",
        "##   ## ",
        "##   ## ",
        "##   ## ",
        "##   ## ",
        "##   ## ",
        " #####  ",
        "        ",
    ],
    'V': [
        "##   ## ",
        "##   ## ",
        "##   ## ",
        "##   ## ",
        " ## ##  ",
        "  ###   ",
        "   #    ",
        "        ",
    ],
    'W': [
        "##   ## ",
        "##   ## ",
        "##   ## ",
        "## # ## ",
        "## # ## ",
        "### ### ",
        " ## ##  ",
        "        ",
    ],
    'X': [
        "##   ## ",
        " ## ##  ",
        "  ###   ",
        "   #    ",
        "  ###   ",
        " ## ##  ",
        "##   ## ",
        "        ",
    ],
    'Y': [
        "##   ## ",
        " ## ##  ",
        "  ###   ",
        "   #    ",
        "   #    ",
        "   #    ",
        "   #    ",
        "        ",
    ],
    'Z': [
        "########",
        "     ## ",
        "    ##  ",
        "   ##   ",
        "  ##    ",
        " ##     ",
        "########",
        "        ",
    ],
    '[': [
        "  ####  ",
        "  ##    ",
        "  ##    ",
        "  ##    ",
        "  ##    ",
        "  ##    ",
        "  ####  ",
        "        ",
    ],
    '\\': [
        "##      ",
        " ##     ",
        "  ##    ",
        "   ##   ",
        "    ##  ",
        "     ## ",
        "      ##",
        "        ",
    ],
    ']': [
        "  ####  ",
        "    ##  ",
        "    ##  ",
        "    ##  ",
        "    ##  ",
        "    ##  ",
        "  ####  ",
        "        ",
    ],
    '^': [
        "   ##   ",
        "  ####  ",
        " ##  ## ",
        "        ",
        "        ",
        "        ",
        "        ",
        "        ",
    ],
    '_': [
        "        ",
        "        ",
        "        ",
        "        ",
        "        ",
        "        ",
        "########",
        "        ",
    ],
    '`': [
        "  ##    ",
        "   ##   ",
        "        ",
        "        ",
        "        ",
        "        ",
        "        ",
        "        ",
    ],
    'a': [
        "        ",
        "        ",
        " #####  ",
        "     ## ",
        " ###### ",
        "##   ## ",
        " ###### ",
        "        ",
    ],
    'b': [
        "##      ",
        "##      ",
        "######  ",
        "##   ## ",
        "##   ## ",
        "##   ## ",
        "######  ",
        "        ",
    ],
    'c': [
        "        ",
        "        ",
        " #####  ",
        "##      ",
        "##      ",
        "##      ",
        " #####  ",
        "        ",
    ],
    'd': [
        "     ## ",
        "     ## ",
        " ###### ",
        "##   ## ",
        "##   ## ",
        "##   ## ",
        " ###### ",
        "        ",
    ],
    'e': [
        "        ",
        "        ",
        " #####  ",
        "##   ## ",
        "####### ",
        "##      ",
        " #####  ",
        "        ",
    ],
    'f': [
        "   #### ",
        "  ##    ",
        " #####  ",
        "  ##    ",
        "  ##    ",
        "  ##    ",
        "  ##    ",
        "        ",
    ],
    'g': [
        "        ",
        " ###### ",
        "##   ## ",
        "##   ## ",
        " ###### ",
        "     ## ",
        " #####  ",
        "        ",
    ],
    'h': [
        "##      ",
        "##      ",
        "######  ",
        "##   ## ",
        "##   ## ",
        "##   ## ",
        "##   ## ",
        "        ",
    ],
    'i': [
        "   ##   ",
        "        ",
        "  ###   ",
        "   ##   ",
        "   ##   ",
        "   ##   ",
        " ###### ",
        "        ",
    ],
    'j': [
        "    ##  ",
        "        ",
        "   ###  ",
        "    ##  ",
        "    ##  ",
        "##  ##  ",
        " ####   ",
        "        ",
    ],
    'k': [
        "##      ",
        "##      ",
        "##  ##  ",
        "## ##   ",
        "####    ",
        "## ##   ",
        "##  ##  ",
        "        ",
    ],
    'l': [
        "  ###   ",
        "   ##   ",
        "   ##   ",
        "   ##   ",
        "   ##   ",
        "   ##   ",
        " ###### ",
        "        ",
    ],
    'm': [
        "        ",
        "        ",
        "### ##  ",
        "## # ## ",
        "## # ## ",
        "##   ## ",
        "##   ## ",
        "        ",
    ],
    'n': [
        "        ",
        "        ",
        "######  ",
        "##   ## ",
        "##   ## ",
        "##   ## ",
        "##   ## ",
        "        ",
    ],
    'o': [
        "        ",
        "        ",
        " #####  ",
        "##   ## ",
        "##   ## ",
        "##   ## ",
        " #####  ",
        "        ",
    ],
    'p': [
        "        ",
        "        ",
        "######  ",
        "##   ## ",
        "######  ",
        "##      ",
        "##      ",
        "        ",
    ],
    'q': [
        "        ",
        "        ",
        " ###### ",
        "##   ## ",
        " ###### ",
        "     ## ",
        "     ## ",
        "        ",
    ],
    'r': [
        "        ",
        "        ",
        "## ###  ",
        "###     ",
        "##      ",
        "##      ",
        "##      ",
        "        ",
    ],
    's': [
        "        ",
        "        ",
        " #####  ",
        "##      ",
        " #####  ",
        "     ## ",
        " #####  ",
        "        ",
    ],
    't': [
        "  ##    ",
        "  ##    ",
        "#####   ",
        "  ##    ",
        "  ##    ",
        "  ##    ",
        "   ###  ",
        "        ",
    ],
    'u': [
        "        ",
        "        ",
        "##   ## ",
        "##   ## ",
        "##   ## ",
        "##   ## ",
        " ###### ",
        "        ",
    ],
    'v': [
        "        ",
        "        ",
        "##   ## ",
        "##   ## ",
        " ## ##  ",
        "  ###   ",
        "   #    ",
        "        ",
    ],
    'w': [
        "        ",
        "        ",
        "##   ## ",
        "##   ## ",
        "## # ## ",
        "## # ## ",
        " ## ##  ",
        "        ",
    ],
    'x': [
        "        ",
        "        ",
        "##   ## ",
        " ## ##  ",
        "  ###   ",
        " ## ##  ",
        "##   ## ",
        "        ",
    ],
    'y': [
        "        ",
        "        ",
        "##   ## ",
        "##   ## ",
        " ###### ",
        "     ## ",
        " #####  ",
        "        ",
    ],
    'z': [
        "        ",
        "        ",
        "####### ",
        "   ##   ",
        "  ##    ",
        " ##     ",
        "####### ",
        "        ",
    ],
    '{': [
        "    ### ",
        "   ##   ",
        "   ##   ",
        " ###    ",
        "   ##   ",
        "   ##   ",
        "    ### ",
        "        ",
    ],
    '|': [
        "   ##   ",
        "   ##   ",
        "   ##   ",
        "   ##   ",
        "   ##   ",
        "   ##   ",
        "   ##   ",
        "        ",
    ],
    '}': [
        " ###    ",
        "   ##   ",
        "   ##   ",
        "    ### ",
        "   ##   ",
        "   ##   ",
        " ###    ",
        "        ",
    ],
    '~': [
        " ##  ## ",
        "##  ##  ",
        "        ",
        "        ",
        "        ",
        "        ",
        "        ",
        "        ",
    ],
}


def char_to_pixels(char):
    """Convert a character to 8x8 pixel array (1=foreground, 0=background)"""
    if char in FONT:
        glyph = FONT[char]
    else:
        glyph = FONT.get(' ', ['        '] * 8)

    pixels = []
    for row in glyph:
        row_pixels = []
        for i in range(8):
            if i < len(row) and row[i] == '#':
                row_pixels.append(1)  # Color 1 (foreground)
            else:
                row_pixels.append(0)  # Color 0 (transparent/background)
        pixels.append(row_pixels)
    return pixels


def pixels_to_tile(pixels):
    """
    Convert 8x8 pixel array to 32-byte NeoGeo S-ROM tile format.

    Address bits: nHCLLL
      H = half (0=right cols 4-7, 1=left cols 0-3)
      C = column pair within half (0=outer, 1=inner)
      L = line (0-7)

    Each byte: left pixel in bits 0-3, right pixel in bits 4-7

    Byte order:
      0-7:   H=0,C=0 -> cols 4,5, lines 0-7
      8-15:  H=0,C=1 -> cols 6,7, lines 0-7
      16-23: H=1,C=0 -> cols 0,1, lines 0-7
      24-31: H=1,C=1 -> cols 2,3, lines 0-7
    """
    tile = bytearray(32)

    for line in range(8):
        # Right half, outer (cols 4,5)
        tile[0 + line] = (pixels[line][4] & 0xF) | ((pixels[line][5] & 0xF) << 4)
        # Right half, inner (cols 6,7)
        tile[8 + line] = (pixels[line][6] & 0xF) | ((pixels[line][7] & 0xF) << 4)
        # Left half, outer (cols 0,1)
        tile[16 + line] = (pixels[line][0] & 0xF) | ((pixels[line][1] & 0xF) << 4)
        # Left half, inner (cols 2,3)
        tile[24 + line] = (pixels[line][2] & 0xF) | ((pixels[line][3] & 0xF) << 4)

    return bytes(tile)


def generate_srom(output_file, size_kb=128, bios_sfix=None):
    """Generate a complete S-ROM with font tiles

    Args:
        output_file: Output S-ROM filename
        size_kb: Size of output in KB
        bios_sfix: Optional path to existing sfix with BIOS tiles to preserve
    """
    rom = bytearray(size_kb * 1024)

    # If we have a BIOS sfix, copy the BIOS tiles (tiles 0-31, offsets 0x000-0x3FF)
    # These are used by the BIOS for the eye catcher animation
    if bios_sfix:
        try:
            with open(bios_sfix, 'rb') as f:
                bios_data = f.read()
            # Copy tiles 0-31 (first 1024 bytes) for BIOS graphics
            rom[0:1024] = bios_data[0:1024]
            print(f"Copied BIOS tiles from {bios_sfix}")
        except Exception as e:
            print(f"Warning: Could not read BIOS sfix: {e}")

    # Generate font tiles for ASCII 32-127 (printable characters)
    # These go at their ASCII positions (tile N = ASCII N)
    for i in range(32, 128):
        char = chr(i)
        pixels = char_to_pixels(char)
        tile = pixels_to_tile(pixels)
        offset = i * 32
        rom[offset:offset + 32] = tile

    with open(output_file, 'wb') as f:
        f.write(rom)

    print(f"Generated {output_file} ({size_kb}KB)")


if __name__ == '__main__':
    import argparse
    parser = argparse.ArgumentParser(description='Generate NeoGeo S-ROM font')
    parser.add_argument('output', nargs='?', default='sfix.bin', help='Output file')
    parser.add_argument('--bios', '-b', help='BIOS sfix to copy tiles 0-31 from')
    args = parser.parse_args()
    generate_srom(args.output, bios_sfix=args.bios)
