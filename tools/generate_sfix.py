#!/usr/bin/env python3
# This file is part of ProGearSDK.
# Copyright (c) 2024-2025 ProGearSDK contributors
# SPDX-License-Identifier: MIT

"""
generate_sfix.py - Generate S-ROM with ASCII font for NeoGeo fix layer

S-ROM tile format (8x8 pixels, 4bpp, 32 bytes per tile):
  - Pixels stored in COLUMNS, not rows
  - Each byte contains 2 pixels: left pixel in bits 0-3, right pixel in bits 4-7
  - Column pairs stored in order: (4,5), (6,7), (0,1), (2,3)

Address formula: ...nHCLLL
  - n = tile number
  - H = half (0=right cols 4-7, 1=left cols 0-3)
  - C = column within half (0=left pair, 1=right pair)
  - L = line/row (0-7)

Font uses color index 1 for pixels, 0 for background.
Tiles 0x00-0x5F map to ASCII 0x20-0x7F (space through ~).
"""

import sys

# 8x8 font bitmap data for ASCII 0x20-0x7F (96 characters)
# Each character is 8 bytes (1 byte per row, MSB is leftmost pixel)
FONT_8X8 = [
    # 0x20 ' ' (space)
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
    # 0x21 '!'
    [0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x00],
    # 0x22 '"'
    [0x6C, 0x6C, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00],
    # 0x23 '#'
    [0x6C, 0x6C, 0xFE, 0x6C, 0xFE, 0x6C, 0x6C, 0x00],
    # 0x24 '$'
    [0x18, 0x3E, 0x60, 0x3C, 0x06, 0x7C, 0x18, 0x00],
    # 0x25 '%'
    [0x00, 0xC6, 0xCC, 0x18, 0x30, 0x66, 0xC6, 0x00],
    # 0x26 '&'
    [0x38, 0x6C, 0x38, 0x76, 0xDC, 0xCC, 0x76, 0x00],
    # 0x27 "'"
    [0x18, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00],
    # 0x28 '('
    [0x0C, 0x18, 0x30, 0x30, 0x30, 0x18, 0x0C, 0x00],
    # 0x29 ')'
    [0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x18, 0x30, 0x00],
    # 0x2A '*'
    [0x00, 0x66, 0x3C, 0xFF, 0x3C, 0x66, 0x00, 0x00],
    # 0x2B '+'
    [0x00, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x00, 0x00],
    # 0x2C ','
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x30],
    # 0x2D '-'
    [0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00],
    # 0x2E '.'
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00],
    # 0x2F '/'
    [0x06, 0x0C, 0x18, 0x30, 0x60, 0xC0, 0x80, 0x00],
    # 0x30 '0'
    [0x7C, 0xC6, 0xCE, 0xD6, 0xE6, 0xC6, 0x7C, 0x00],
    # 0x31 '1'
    [0x18, 0x38, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x00],
    # 0x32 '2'
    [0x7C, 0xC6, 0x06, 0x1C, 0x30, 0x66, 0xFE, 0x00],
    # 0x33 '3'
    [0x7C, 0xC6, 0x06, 0x3C, 0x06, 0xC6, 0x7C, 0x00],
    # 0x34 '4'
    [0x1C, 0x3C, 0x6C, 0xCC, 0xFE, 0x0C, 0x1E, 0x00],
    # 0x35 '5'
    [0xFE, 0xC0, 0xC0, 0xFC, 0x06, 0xC6, 0x7C, 0x00],
    # 0x36 '6'
    [0x38, 0x60, 0xC0, 0xFC, 0xC6, 0xC6, 0x7C, 0x00],
    # 0x37 '7'
    [0xFE, 0xC6, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x00],
    # 0x38 '8'
    [0x7C, 0xC6, 0xC6, 0x7C, 0xC6, 0xC6, 0x7C, 0x00],
    # 0x39 '9'
    [0x7C, 0xC6, 0xC6, 0x7E, 0x06, 0x0C, 0x78, 0x00],
    # 0x3A ':'
    [0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x00],
    # 0x3B ';'
    [0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x30],
    # 0x3C '<'
    [0x06, 0x0C, 0x18, 0x30, 0x18, 0x0C, 0x06, 0x00],
    # 0x3D '='
    [0x00, 0x00, 0x7E, 0x00, 0x00, 0x7E, 0x00, 0x00],
    # 0x3E '>'
    [0x60, 0x30, 0x18, 0x0C, 0x18, 0x30, 0x60, 0x00],
    # 0x3F '?'
    [0x7C, 0xC6, 0x0C, 0x18, 0x18, 0x00, 0x18, 0x00],
    # 0x40 '@'
    [0x7C, 0xC6, 0xDE, 0xDE, 0xDE, 0xC0, 0x78, 0x00],
    # 0x41 'A'
    [0x38, 0x6C, 0xC6, 0xFE, 0xC6, 0xC6, 0xC6, 0x00],
    # 0x42 'B'
    [0xFC, 0x66, 0x66, 0x7C, 0x66, 0x66, 0xFC, 0x00],
    # 0x43 'C'
    [0x3C, 0x66, 0xC0, 0xC0, 0xC0, 0x66, 0x3C, 0x00],
    # 0x44 'D'
    [0xF8, 0x6C, 0x66, 0x66, 0x66, 0x6C, 0xF8, 0x00],
    # 0x45 'E'
    [0xFE, 0x62, 0x68, 0x78, 0x68, 0x62, 0xFE, 0x00],
    # 0x46 'F'
    [0xFE, 0x62, 0x68, 0x78, 0x68, 0x60, 0xF0, 0x00],
    # 0x47 'G'
    [0x3C, 0x66, 0xC0, 0xC0, 0xCE, 0x66, 0x3A, 0x00],
    # 0x48 'H'
    [0xC6, 0xC6, 0xC6, 0xFE, 0xC6, 0xC6, 0xC6, 0x00],
    # 0x49 'I'
    [0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00],
    # 0x4A 'J'
    [0x1E, 0x0C, 0x0C, 0x0C, 0xCC, 0xCC, 0x78, 0x00],
    # 0x4B 'K'
    [0xE6, 0x66, 0x6C, 0x78, 0x6C, 0x66, 0xE6, 0x00],
    # 0x4C 'L'
    [0xF0, 0x60, 0x60, 0x60, 0x62, 0x66, 0xFE, 0x00],
    # 0x4D 'M'
    [0xC6, 0xEE, 0xFE, 0xFE, 0xD6, 0xC6, 0xC6, 0x00],
    # 0x4E 'N'
    [0xC6, 0xE6, 0xF6, 0xDE, 0xCE, 0xC6, 0xC6, 0x00],
    # 0x4F 'O'
    [0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x7C, 0x00],
    # 0x50 'P'
    [0xFC, 0x66, 0x66, 0x7C, 0x60, 0x60, 0xF0, 0x00],
    # 0x51 'Q'
    [0x7C, 0xC6, 0xC6, 0xC6, 0xD6, 0x7C, 0x0E, 0x00],
    # 0x52 'R'
    [0xFC, 0x66, 0x66, 0x7C, 0x6C, 0x66, 0xE6, 0x00],
    # 0x53 'S'
    [0x7C, 0xC6, 0x60, 0x38, 0x0C, 0xC6, 0x7C, 0x00],
    # 0x54 'T'
    [0x7E, 0x7E, 0x5A, 0x18, 0x18, 0x18, 0x3C, 0x00],
    # 0x55 'U'
    [0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x7C, 0x00],
    # 0x56 'V'
    [0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x6C, 0x38, 0x00],
    # 0x57 'W'
    [0xC6, 0xC6, 0xC6, 0xD6, 0xFE, 0xEE, 0xC6, 0x00],
    # 0x58 'X'
    [0xC6, 0xC6, 0x6C, 0x38, 0x6C, 0xC6, 0xC6, 0x00],
    # 0x59 'Y'
    [0x66, 0x66, 0x66, 0x3C, 0x18, 0x18, 0x3C, 0x00],
    # 0x5A 'Z'
    [0xFE, 0xC6, 0x8C, 0x18, 0x32, 0x66, 0xFE, 0x00],
    # 0x5B '['
    [0x3C, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3C, 0x00],
    # 0x5C '\'
    [0xC0, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x02, 0x00],
    # 0x5D ']'
    [0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3C, 0x00],
    # 0x5E '^'
    [0x10, 0x38, 0x6C, 0xC6, 0x00, 0x00, 0x00, 0x00],
    # 0x5F '_'
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF],
    # 0x60 '`'
    [0x30, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00],
    # 0x61 'a'
    [0x00, 0x00, 0x78, 0x0C, 0x7C, 0xCC, 0x76, 0x00],
    # 0x62 'b'
    [0xE0, 0x60, 0x7C, 0x66, 0x66, 0x66, 0xDC, 0x00],
    # 0x63 'c'
    [0x00, 0x00, 0x7C, 0xC6, 0xC0, 0xC6, 0x7C, 0x00],
    # 0x64 'd'
    [0x1C, 0x0C, 0x7C, 0xCC, 0xCC, 0xCC, 0x76, 0x00],
    # 0x65 'e'
    [0x00, 0x00, 0x7C, 0xC6, 0xFE, 0xC0, 0x7C, 0x00],
    # 0x66 'f'
    [0x38, 0x6C, 0x60, 0xF8, 0x60, 0x60, 0xF0, 0x00],
    # 0x67 'g'
    [0x00, 0x00, 0x76, 0xCC, 0xCC, 0x7C, 0x0C, 0xF8],
    # 0x68 'h'
    [0xE0, 0x60, 0x6C, 0x76, 0x66, 0x66, 0xE6, 0x00],
    # 0x69 'i'
    [0x18, 0x00, 0x38, 0x18, 0x18, 0x18, 0x3C, 0x00],
    # 0x6A 'j'
    [0x06, 0x00, 0x0E, 0x06, 0x06, 0x66, 0x66, 0x3C],
    # 0x6B 'k'
    [0xE0, 0x60, 0x66, 0x6C, 0x78, 0x6C, 0xE6, 0x00],
    # 0x6C 'l'
    [0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00],
    # 0x6D 'm'
    [0x00, 0x00, 0xEC, 0xFE, 0xD6, 0xD6, 0xD6, 0x00],
    # 0x6E 'n'
    [0x00, 0x00, 0xDC, 0x66, 0x66, 0x66, 0x66, 0x00],
    # 0x6F 'o'
    [0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0x7C, 0x00],
    # 0x70 'p'
    [0x00, 0x00, 0xDC, 0x66, 0x66, 0x7C, 0x60, 0xF0],
    # 0x71 'q'
    [0x00, 0x00, 0x76, 0xCC, 0xCC, 0x7C, 0x0C, 0x1E],
    # 0x72 'r'
    [0x00, 0x00, 0xDC, 0x76, 0x60, 0x60, 0xF0, 0x00],
    # 0x73 's'
    [0x00, 0x00, 0x7E, 0xC0, 0x7C, 0x06, 0xFC, 0x00],
    # 0x74 't'
    [0x30, 0x30, 0xFC, 0x30, 0x30, 0x36, 0x1C, 0x00],
    # 0x75 'u'
    [0x00, 0x00, 0xCC, 0xCC, 0xCC, 0xCC, 0x76, 0x00],
    # 0x76 'v'
    [0x00, 0x00, 0xC6, 0xC6, 0xC6, 0x6C, 0x38, 0x00],
    # 0x77 'w'
    [0x00, 0x00, 0xC6, 0xD6, 0xD6, 0xFE, 0x6C, 0x00],
    # 0x78 'x'
    [0x00, 0x00, 0xC6, 0x6C, 0x38, 0x6C, 0xC6, 0x00],
    # 0x79 'y'
    [0x00, 0x00, 0xC6, 0xC6, 0xC6, 0x7E, 0x06, 0xFC],
    # 0x7A 'z'
    [0x00, 0x00, 0xFE, 0x8C, 0x18, 0x32, 0xFE, 0x00],
    # 0x7B '{'
    [0x0E, 0x18, 0x18, 0x70, 0x18, 0x18, 0x0E, 0x00],
    # 0x7C '|'
    [0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00],
    # 0x7D '}'
    [0x70, 0x18, 0x18, 0x0E, 0x18, 0x18, 0x70, 0x00],
    # 0x7E '~'
    [0x76, 0xDC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
    # 0x7F DEL (block character)
    [0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF],
]


def get_pixel(bitmap, x, y):
    """Get pixel value (0 or 1) from bitmap at (x, y)."""
    # bitmap[y] is a byte where MSB is leftmost pixel (x=0)
    return 1 if (bitmap[y] & (0x80 >> x)) else 0


def bitmap_to_srom_tile(bitmap):
    """
    Convert 8x8 bitmap to 32-byte S-ROM tile format.

    S-ROM format stores pixels in columns, with specific ordering:
    - Bytes 0-7:   columns 4,5, rows 0-7
    - Bytes 8-15:  columns 6,7, rows 0-7
    - Bytes 16-23: columns 0,1, rows 0-7
    - Bytes 24-31: columns 2,3, rows 0-7

    Each byte: left pixel (even col) in bits 0-3, right pixel (odd col) in bits 4-7
    """
    tile = bytearray(32)

    # Column pairs in storage order: (4,5), (6,7), (0,1), (2,3)
    col_pairs = [(4, 5), (6, 7), (0, 1), (2, 3)]

    for pair_idx, (col_left, col_right) in enumerate(col_pairs):
        for row in range(8):
            byte_idx = pair_idx * 8 + row

            # Get pixel values (0 or 1 for our 1-bit font, using color index 1)
            left_pixel = get_pixel(bitmap, col_left, row)
            right_pixel = get_pixel(bitmap, col_right, row)

            # Pack into byte: left pixel in bits 0-3, right pixel in bits 4-7
            tile[byte_idx] = left_pixel | (right_pixel << 4)

    return bytes(tile)


def main():
    output_path = 'sfix.bin'
    if len(sys.argv) > 1:
        output_path = sys.argv[1]

    # Create S-ROM data
    srom = bytearray()

    # Generate tiles for ASCII 0x20-0x7F (96 characters)
    for char_bitmap in FONT_8X8:
        tile = bitmap_to_srom_tile(char_bitmap)
        srom.extend(tile)

    # Pad to 64KB minimum
    while len(srom) < 0x10000:
        srom.append(0)

    with open(output_path, 'wb') as f:
        f.write(srom)

    print(f"Generated {output_path} ({len(srom)} bytes)")
    print(f"  - {len(FONT_8X8)} font tiles (ASCII 0x20-0x7F)")


if __name__ == '__main__':
    main()
